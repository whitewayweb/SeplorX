# Database Design

## Provider

Supabase PostgreSQL with two connection modes:
- **Port 6543** (transaction pooler via PgBouncer) — app runtime and local dev
- **Port 5432** (direct connection) — migrations only (`yarn db:migrate`)

## Connection

Single `postgres-js` connection cached in module scope (`globalForDb` pattern) to prevent leaks during Next.js hot reload. Max 1 connection per serverless instance — PgBouncer handles pooling.

File: `src/db/index.ts`

## Tables

### users

Existing table for user accounts.

| Column | Type | Constraints |
|--------|------|-------------|
| id | serial | PK |
| name | varchar(255) | nullable |
| email | varchar(255) | NOT NULL, UNIQUE |
| password | varchar(255) | nullable |
| role | enum("admin","customer") | NOT NULL, default "customer" |
| created_at | timestamp | default now() |

### app_installations

Stores which apps a user has installed and their configuration.

| Column | Type | Constraints |
|--------|------|-------------|
| id | serial | PK |
| user_id | integer | NOT NULL, FK → users.id (CASCADE) |
| app_id | varchar(100) | NOT NULL (matches registry key) |
| status | enum("installed","configured") | NOT NULL, default "installed" |
| config | jsonb | default {} |
| installed_at | timestamp | default now() |
| updated_at | timestamp | default now() |

**Unique index**: `(user_id, app_id)` — one installation per user per app.

**Note**: `app_id` references the TypeScript registry, not another DB table. The registry is the source of truth for app definitions.

## JSONB Config Column

The `config` column stores a flat `Record<string, string>`. Sensitive fields (where `type === "password"` in the app registry) are encrypted with AES-256-GCM before storage:

```json
{
  "apiKey": "a1b2c3d4...:e5f6a7b8...:9c0d1e2f...",
  "accountId": "ACC-12345"
}
```

Encrypted values use the format `iv:authTag:ciphertext` (all hex-encoded). Non-sensitive fields are stored as plain text.

The app registry defines which keys are valid. Zod validates dynamically before writes. See `src/lib/crypto.ts` for encrypt/decrypt utilities.

## Enums

| Enum | Values | Used By |
|------|--------|---------|
| role | admin, customer | users.role |
| app_status | installed, configured | app_installations.status |

## Conventions

- Use Drizzle ORM for all queries (`db` export from `@/db`)
- Schema types from `@/db/schema`
- Run `yarn db` (generate + migrate) after schema changes
- Always use the transaction pooler URL (port 6543) in the app
- Direct connection (port 5432) only for `yarn db:migrate`

## Migrations

Stored in `drizzle/` directory. Generated by `drizzle-kit generate`, applied by `drizzle-kit migrate`. PostgreSQL dialect.
